%% Control Digital en Sistemas Embebidos - MSE - PRACTICA 2

pkg load signal
pkg load control

clc
clear all
close all
%%
% 1) Crear una función en Matlab que aplique la función de identificación por 
% método de cuadrados mínimos (LS) y obtenga el vector de parámetros del modelo 
% a partir del orden deseado del sistema y las señales de entrada/salida.
%%

function [Theta] = identificacionLS(n, u, y)
  Y = y(n+1:length(y));
  Phi = [];
  for i=n:-1:1
    Phi = [Phi y(i:(length(y)+i-n-1))];
  end
  for j=(n+1):-1:1
    Phi = [Phi u(j:(length(y)+j-n-1))];
  end
  Theta = (Phi'*Phi)^(-1)*Phi'*Y;
end

%%
% 2) Crear una función en Matlab que aplique la función de identificación por 
% método de cuadrados mínimos recursivo (RLS) y obtenga el vector de parámetros 
% del modelo a partir del orden deseado del sistema y las señales de 
% entrada/salida.
%%

function [Theta P] = identificacionRLS(n, u, y, lastP, lastTheta)
  Phi = [];
  for i=n:-1:1
    Phi = [Phi y(i)];
  end
  for j=(n+1):-1:1
    Phi = [Phi u(j)];
  end
  P = lastP - lastP*Phi'*Phi*lastP/(1+Phi*lastP*Phi');
  K = lastP*Phi'/(1+Phi*lastP*Phi');
  Theta = lastTheta + K*(y(n+1)-Phi*lastTheta);
end

%%
% 3) Discretizar la planta con un período de muestreo h = 0.1s.
%%

h = 0.1;

num = [ 1 1 ];
den = [ 1 0.5 1];

Hs= tf(num, den)

Hz = c2d(Hs, h, 'zoh')

%%
% 4) Identificar los parámetros de la planta para orden 2 y 3 utilizando la 
% función LS creada anteriormente.
%%

t = 1:h:40;


[numz, denz] = tfdata(Hz, 'v')

%u = rand(length(t), 1);
%y = filter(numz, denz, u);

u = [ 1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;2.13226;2.13226;2.13226;2.13226;2.13226;2.13226;2.13226;2.13226;2.13226;2.13226];
y = [ 0.00645;1.06452;1.06452;1.06774;1.17419;1.31613;1.41935;1.49677;1.55484;1.59677;1.62903;1.65161;1.67097;1.68387;1.69677;1.70323;1.70968;1.71290;1.71935;1.72258;1.72258;1.72581;1.72581;1.72581;1.72903;1.72903;1.72903;1.72903;1.72903;1.73226;1.73226;1.73226;1.75161;1.76774;1.77742;1.78387;1.79032;1.79355;1.79677;1.80000;1.80323;1.80323;1.80323;1.80645;1.80645;1.80645;1.80645;1.80645;1.80645;1.80645;1.80645;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80645;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.88064;1.93226;1.97097;1.99677;2.01613;2.03226;2.04194;2.05161;2.05806;2.06129;2.06452;2.06774;2.07097;2.07097;2.07419;2.07419;2.07419;2.07419;2.07419;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.05806;2.04194;2.03226;2.02258;2.01935;2.01290;2.00968;2.00968;2.00645;2.00323;2.00323;2.00645;2.00323;2.00323;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;1.99677;1.77742;1.61290;1.49677;1.41290;1.34839;1.30000;1.26452;1.23871;1.21935;1.20645;1.19677;1.18710;1.18064;1.17742;1.17097;1.17097;1.16774;1.16452;1.16452;1.16452;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.16129;1.36129;1.50645;1.61290;1.69032;1.74839;1.79032;1.82258;1.84516;1.86129;1.87419;1.88387;1.89355;1.90000;1.90323;1.90645;1.90968;1.90968;1.91290;1.91290;1.91290;1.91613;1.91613;1.91613;1.91613;1.91613;1.91613;1.91613;1.91613;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.80000;1.71290;1.64839;1.60323;1.56774;1.54516;1.52581;1.50968;1.50000;1.49355;1.48710;1.48387;1.48064;1.47742;1.47419;1.47419;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.52581;1.56774;1.59677;1.61935;1.63871;1.64839;1.65806;1.66452;1.67097;1.67419;1.67742;1.68064;1.68064;1.68064;1.68387;1.68387;1.68387;1.68387;1.68387;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.80645;1.89032;1.95161;1.99677;2.02903;2.05484;2.07419;2.08710;2.09677];

[Theta_LS_1] = identificacionLS(1, u, y)
numz_LS_1 = [Theta_LS_1(2) Theta_LS_1(3)]
denz_LS_1 = [1 -Theta_LS_1(1)]

[Theta_LS_2] = identificacionLS(2, u, y)
numz_LS_2 = [Theta_LS_2(3) Theta_LS_2(4) Theta_LS_2(5)]
denz_LS_2 = [1 -Theta_LS_2(1) -Theta_LS_2(2)]

%%
% 5)Obtener el error de ambas identificaciones utilizando la función de costo J.
%%

y_LS_1 = filter(numz_LS_1, denz_LS_1, u);
J_1 = (y-y_LS_1)'*(y-y_LS_1)/2

y_LS_2 = filter(numz_LS_2, denz_LS_2, u);
J_2 = (y-y_LS_2)'*(y-y_LS_2)/2

%%
% 6)Comparar la respuesta de los modelos obtenidos en el punto 4 con la 
% respuesta de la planta real utilizando la misma señal de entrada.
%%

%u = rand(length(t), 1);
%y = filter(numz, denz, u);

u = [ 1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.73871;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;1.81290;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.08064;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;2.00323;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.92258;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;1.69032;2.13226;2.13226;2.13226;2.13226;2.13226;2.13226;2.13226;2.13226;2.13226;2.13226];
y = [ 0.00645;1.06452;1.06452;1.06774;1.17419;1.31613;1.41935;1.49677;1.55484;1.59677;1.62903;1.65161;1.67097;1.68387;1.69677;1.70323;1.70968;1.71290;1.71935;1.72258;1.72258;1.72581;1.72581;1.72581;1.72903;1.72903;1.72903;1.72903;1.72903;1.73226;1.73226;1.73226;1.75161;1.76774;1.77742;1.78387;1.79032;1.79355;1.79677;1.80000;1.80323;1.80323;1.80323;1.80645;1.80645;1.80645;1.80645;1.80645;1.80645;1.80645;1.80645;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80645;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.80968;1.88064;1.93226;1.97097;1.99677;2.01613;2.03226;2.04194;2.05161;2.05806;2.06129;2.06452;2.06774;2.07097;2.07097;2.07419;2.07419;2.07419;2.07419;2.07419;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.07742;2.05806;2.04194;2.03226;2.02258;2.01935;2.01290;2.00968;2.00968;2.00645;2.00323;2.00323;2.00645;2.00323;2.00323;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;2.00000;1.99677;1.77742;1.61290;1.49677;1.41290;1.34839;1.30000;1.26452;1.23871;1.21935;1.20645;1.19677;1.18710;1.18064;1.17742;1.17097;1.17097;1.16774;1.16452;1.16452;1.16452;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.16129;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.15806;1.16129;1.36129;1.50645;1.61290;1.69032;1.74839;1.79032;1.82258;1.84516;1.86129;1.87419;1.88387;1.89355;1.90000;1.90323;1.90645;1.90968;1.90968;1.91290;1.91290;1.91290;1.91613;1.91613;1.91613;1.91613;1.91613;1.91613;1.91613;1.91613;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.91935;1.80000;1.71290;1.64839;1.60323;1.56774;1.54516;1.52581;1.50968;1.50000;1.49355;1.48710;1.48387;1.48064;1.47742;1.47419;1.47419;1.47097;1.47097;1.47097;1.47097;1.47097;1.47097;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.46774;1.52581;1.56774;1.59677;1.61935;1.63871;1.64839;1.65806;1.66452;1.67097;1.67419;1.67742;1.68064;1.68064;1.68064;1.68387;1.68387;1.68387;1.68387;1.68387;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.68710;1.80645;1.89032;1.95161;1.99677;2.02903;2.05484;2.07419;2.08710;2.09677];

y_LS_1 = filter(numz_LS_1, denz_LS_1, u);
y_LS_2 = filter(numz_LS_2, denz_LS_2, u);

figure;
hold on;
plot(t, u)
plot(t, y, 'LineWidth', 3)
plot(t, y_LS_1, 'LineWidth', 3)
plot(t, y_LS_2, '--', 'LineWidth', 3)
legend('u', 'y', 'y_LS_1', 'y_LS_2')

%%
% 7) Identificar los parámetros de la planta utilizando la función RLS creada
% anteriormente. Obtener y comparar identificaciones con Pinicial = 100.I y
% Pinicial = 1000.I.
%%

N = 300;

Theta_RLS_1 = [0; 0; 0; 0; 0];
P = eye(5)*100;

% u(k-2) u(k-1) u(k) y(k-2) y(k-1) y(k)

for i=3:N
  [Theta_RLS_1 P] = identificacionRLS(2, u(i-2:i), y(i-2:i), P, Theta_RLS_1);
end

numz_RLS_1 = [Theta_RLS_1(3) Theta_RLS_1(4) Theta_RLS_1(5)]
denz_RLS_1 = [1 -Theta_RLS_1(1) -Theta_RLS_1(2)]


Theta_RLS_2 = [0; 0; 0; 0; 0];
P = eye(5)*1000;

% u(k-2) u(k-1) u(k) y(k-2) y(k-1) y(k)

for i=3:N
  [Theta_RLS_2 P] = identificacionRLS(2, u(i-2:i), y(i-2:i), P, Theta_RLS_2);
end

numz_RLS_2 = [Theta_RLS_2(3) Theta_RLS_2(4) Theta_RLS_2(5)]
denz_RLS_2 = [1 -Theta_RLS_2(1) -Theta_RLS_2(2)]

%%
% 8) Comparar la respuesta de los modelos obtenidos en el punto anterior con la
% respuesta de la planta real utilizando la misma señal de entrada.
%%

y_RLS_1 = filter(numz_RLS_1, denz_RLS_1, u);
y_RLS_2 = filter(numz_RLS_2, denz_RLS_2, u);

figure;
hold on;
plot(t, u)
plot(t, y, 'LineWidth', 3)
plot(t, y_RLS_1, 'LineWidth', 3)
plot(t, y_RLS_2, '--', 'LineWidth', 3)
legend('u', 'y', 'y_RLS_1', 'y_RLS_2')

